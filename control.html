
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æŠ½å¥–æ§åˆ¶é¢æ¿</title>
  <style>
    body {
      font-family: 'Segoe UI', 'PingFang SC', sans-serif;
      padding: 20px;
    }
    h1 {
      font-size: 2em;
    }
    input[type="file"] {
      margin: 10px 0;
    }
    #draw {
      margin-top: 10px;
      padding: 6px 16px;
      font-size: 16px;
    }
    .log {
      margin-top: 20px;
      color: gray;
    }
  </style>
</head>
<body>
  <h1>ğŸ›ï¸ æŠ½å¥–æ§åˆ¶é¢æ¿</h1>
  <input type="file" id="namesFile" accept=".csv" />
  <br />
  <input type="file" id="prizeFile" accept=".csv" />
  <br />
  <button id="draw">å¼€å§‹æŠ½å¥–</button>
  <div class="log" id="log">å½“å‰æŠ½ä¸­ï¼šæš‚æ— </div>

  <script>
    let names = [];
    let prizes = [];
    let prizeIndex = 0;

    function parseCSV(text) {
      const rows = text.trim().split("\n");
      return rows.map(r => r.split(","));
    }

    document.getElementById("namesFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        names = parseCSV(reader.result);
        console.log("å¯¼å…¥åå•ï¼š", names.length);
      };
      reader.readAsText(file);
    });

    document.getElementById("prizeFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        prizes = parseCSV(reader.result);
        console.log("å¯¼å…¥å¥–å“ï¼š", prizes.length);
      };
      reader.readAsText(file);
    });

    const channel = new BroadcastChannel("draw-channel");
    document.getElementById("draw").onclick = () => {
      if (!names.length || !prizes.length) return alert("è¯·å…ˆå¯¼å…¥CSVæ–‡ä»¶");

      const pick = names[Math.floor(Math.random() * names.length)];
      const currentPrize = prizes[prizeIndex % prizes.length];
      prizeIndex++;

      const data = {
        text: `${pick[0]}ï½œ${pick[1]}ï½œ${pick[2]}`,
        prize: currentPrize[0],
        img: currentPrize[1],
        price: currentPrize[2],
        qty: currentPrize[3]
      };

      channel.postMessage(data);
      document.getElementById("log").textContent = `å½“å‰æŠ½ä¸­ï¼š${data.text}ï½œ${data.prize}`;
    };
  </script>
</body>
</html>
