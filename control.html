<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æŠ½å¥–æ§åˆ¶ç•Œé¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
    }
    h1 {
      color: gold;
      text-shadow: 0 0 10px gold;
    }
    input[type="file"] {
      margin: 1rem;
    }
    button {
      padding: 0.6rem 2rem;
      font-size: 1.2rem;
      background: gold;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
    }
    .status {
      margin-top: 2rem;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ›ï¸ æŠ½å¥–æ§åˆ¶ç•Œé¢</h1>
  <p>ä¸Šä¼ å‚èµ›è€… CSVï¼ˆç¼–å·,å§“å,å›½ç±ï¼‰ï¼š</p>
  <input type="file" id="participants" accept=".csv"><br>
  <p>ä¸Šä¼ å¥–å“ CSVï¼ˆå¥–é¡¹å,å¥–å“å,å›¾ç‰‡è·¯å¾„,ä»·å€¼,æ•°é‡ï¼‰ï¼š</p>
  <input type="file" id="prizes" accept=".csv"><br>
  <button onclick="draw()">å¼€å§‹æŠ½å¥–</button>
  <div class="status" id="status">ç­‰å¾…ä¸Šä¼ ...</div>

  <script>
    const bc = new BroadcastChannel("draw-channel");
    let participants = [], prizes = [], prizeIndex = 0;

    function readCSV(file, callback) {
      const reader = new FileReader();
      reader.onload = () => {
        const rows = reader.result.split("\n").map(row => row.split(","));
        callback(rows);
      };
      reader.readAsText(file);
    }

    document.getElementById("participants").addEventListener("change", e => {
      readCSV(e.target.files[0], data => {
        participants = data;
        document.getElementById("status").textContent = `âœ… å·²ä¸Šä¼ å‚èµ›è€… ${data.length} æ¡`;
      });
    });

    document.getElementById("prizes").addEventListener("change", e => {
      readCSV(e.target.files[0], data => {
        prizes = data;
        document.getElementById("status").textContent += `ï¼Œå·²ä¸Šä¼ å¥–å“ ${data.length} æ¡`;
      });
    });

    function draw() {
      if (!participants.length || !prizes.length) {
        document.getElementById("status").textContent = "âš ï¸ è¯·å…ˆä¸Šä¼ å‚èµ›è€…å’Œå¥–å“ CSV";
        return;
      }
      const p = participants[Math.floor(Math.random() * participants.length)];
      const prize = prizes[prizeIndex % prizes.length];
      prizeIndex++;
      bc.postMessage({
        prizeTitle: prize[0],
        name: prize[1],
        img: prize[2],
        price: prize[3],
        qty: prize[4],
        text: `${p[0]}ï½œ${p[1]}ï½œ${p[2]}`
      });
      document.getElementById("status").textContent = `ğŸ‰ å·²æŠ½ä¸­ï¼š${p[1]}ï¼Œå¥–å“ï¼š${prize[1]}`;
    }
  </script>
</body>
</html>